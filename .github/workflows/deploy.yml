name: Deploy Knytt to GCP

on:
  push:
    branches:
      - main
      - staging
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  GCP_REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  # =====================================================
  # Determine Environment
  # =====================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      deploy: ${{ steps.set-env.outputs.deploy }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

  # =====================================================
  # Run Tests
  # =====================================================
  test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-api.txt
          pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          pytest tests/ --cov=backend --cov-report=xml --cov-report=term

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend

  # =====================================================
  # Build and Push Docker Images
  # =====================================================
  build:
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: needs.setup.outputs.deploy == 'true'
    permissions:
      contents: read
      id-token: write

    outputs:
      sha_short: ${{ steps.vars.outputs.sha_short }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove unnecessary files to free up ~10GB
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo docker system prune -af

          echo "Disk space after cleanup:"
          df -h

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/docker/Dockerfile.api
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-api:${{ steps.vars.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-api:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-api:latest
          cache-to: type=inline

      - name: Build and push Worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/docker/Dockerfile.worker
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-worker:${{ steps.vars.outputs.sha_short }}
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-worker:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-worker:latest
          cache-to: type=inline

  # =====================================================
  # Deploy Infrastructure with Terraform
  # =====================================================
  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    permissions:
      contents: read
      id-token: write

    outputs:
      api_url: ${{ steps.terraform-output.outputs.api_url }}

    defaults:
      run:
        working-directory: deployment/gcp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ needs.setup.outputs.environment }}" \
            -var="supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="supabase_service_key=${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -var="supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="database_url=${{ secrets.DATABASE_URL }}" \
            -var="hf_token=${{ secrets.HF_TOKEN }}" \
            -var="api_image=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-api:${{ needs.build.outputs.sha_short }}" \
            -var="worker_image=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/knytt-${{ needs.setup.outputs.environment }}/knytt-worker:${{ needs.build.outputs.sha_short }}" \
            -out=tfplan

      - name: Terraform Apply
        if: github.event_name != 'pull_request'
        run: terraform apply -auto-approve tfplan

      - name: Get API URL
        if: github.event_name != 'pull_request'
        id: terraform-output
        run: |
          API_URL=$(terraform output -raw api_url)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

  # =====================================================
  # Run Database Migrations
  # =====================================================
  migrate:
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure]
    if: needs.setup.outputs.deploy == 'true' && github.event_name != 'pull_request'
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Run migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # =====================================================
  # Frontend Deployment
  # =====================================================
  # Note: Frontend is deployed separately to Cloudflare Pages
  # and is not part of this automated workflow

  # =====================================================
  # Smoke Tests
  # =====================================================
  smoke-test:
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure, migrate]
    if: needs.setup.outputs.deploy == 'true' && github.event_name != 'pull_request'

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Test API health endpoint
        run: |
          curl -f ${{ needs.deploy-infrastructure.outputs.api_url }}/health || exit 1

      - name: Test API root endpoint
        run: |
          curl -f ${{ needs.deploy-infrastructure.outputs.api_url }}/ || exit 1

  # =====================================================
  # Notification
  # =====================================================
  notify:
    runs-on: ubuntu-latest
    needs: [setup, smoke-test]
    if: always() && needs.setup.outputs.deploy == 'true'

    steps:
      - name: Send notification
        run: |
          STATUS="${{ job.status }}"
          ENV="${{ needs.setup.outputs.environment }}"
          echo "Deployment to $ENV: $STATUS"
          # Add Slack/Discord notification here if needed
